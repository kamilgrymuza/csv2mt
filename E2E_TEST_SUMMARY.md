# End-to-End Test Framework for MT940 Conversion

## Overview

I've created a comprehensive end-to-end (E2E) test framework that allows you to verify MT940 files generated from bank statements (PDF/CSV/Excel) match the official MT940 files provided by your bank.

**✅ Status:** Framework is ready to use. Just add your test files!

## What Was Created

### 1. Test File
**Location:** `backend/tests/test_e2e_bank_comparison.py`

**Features:**
- Compares generated MT940 against bank-provided MT940
- Tests transaction counts, dates, and amounts
- Provides detailed diff reports on failures
- Saves generated MT940 for manual review
- Only runs when explicitly requested (to avoid consuming Claude API credits)

### 2. Test Fixtures Directory
**Location:** `backend/tests/fixtures/e2e/`

**Structure:**
```
e2e/
├── README.md          # Comprehensive documentation
├── QUICKSTART.md      # Step-by-step guide for adding your test case
└── [your_test_case]/  # Your test case directory (to be created)
    ├── statement.pdf      # Your bank statement
    ├── expected.mt940     # Official MT940 from bank
    └── generated.mt940    # Auto-generated by test
```

### 3. Updated Files
- `.gitignore` - Excludes sensitive E2E test fixtures from git
- `backend/tests/conftest.py` - Registers custom `e2e` pytest marker

## How to Use

### Step 1: Add Your Test Case

Create a directory for your test case:
```bash
mkdir -p backend/tests/fixtures/e2e/my_bank_statement
```

### Step 2: Copy Your Files

Copy your two files:
```bash
# Your bank statement (PDF, CSV, or Excel)
cp /path/to/statement.pdf backend/tests/fixtures/e2e/my_bank_statement/statement.pdf

# Official MT940 from your bank
cp /path/to/bank.mt940 backend/tests/fixtures/e2e/my_bank_statement/expected.mt940
```

### Step 3: Run the Test

**With Docker (recommended):**
```bash
docker-compose exec backend pytest tests/test_e2e_bank_comparison.py --run-e2e -v
```

**Without Docker:**
```bash
cd backend
pytest tests/test_e2e_bank_comparison.py --run-e2e -v
```

## Test Results

### ✅ Test Passes
```
tests/test_e2e_bank_comparison.py::...::test_pdf_to_mt940_matches_bank[my_bank_statement] PASSED

✓ Test case 'my_bank_statement' passed: Generated MT940 matches bank MT940
  Generated: backend/tests/fixtures/e2e/my_bank_statement/generated.mt940
  Expected:  backend/tests/fixtures/e2e/my_bank_statement/expected.mt940
```

The conversion is accurate! 🎉

### ❌ Test Fails
```
Statement 0, Transaction 5: Amount differs: generated=-123.45, expected=-123.50
Statement 0, Transaction 7: Date differs: generated=2024-01-15, expected=2024-01-16
```

You can review the differences and check the `generated.mt940` file.

## What the Test Validates

### Hard Checks (Must Match):
- ✅ Number of transactions
- ✅ Transaction dates
- ✅ Transaction amounts (±1 cent tolerance)

### Soft Checks (Warning Only):
- ⚠️ Transaction descriptions (may differ due to AI interpretation)

## Safety Features

1. **API Credit Protection:**
   - Tests only run when you add `--run-e2e` flag
   - Without this flag, tests are automatically skipped
   - Prevents accidental API credit consumption in CI/CD

2. **Data Privacy:**
   - All test fixtures are in `.gitignore`
   - Your sensitive bank data won't be committed to git
   - README files are included, but actual test data is excluded

3. **Test Discovery:**
   - Framework automatically finds all test cases in `e2e/` directory
   - Each subdirectory with `statement.*` and `expected.mt940` becomes a test

## Example Commands

### Run all E2E tests:
```bash
docker-compose exec backend pytest tests/test_e2e_bank_comparison.py --run-e2e -v
```

### Run specific test case:
```bash
docker-compose exec backend pytest tests/test_e2e_bank_comparison.py::TestEndToEndBankComparison::test_pdf_to_mt940_matches_bank[my_bank_statement] --run-e2e -v
```

### Check if test cases exist (doesn't consume credits):
```bash
docker-compose exec backend pytest tests/test_e2e_bank_comparison.py::test_e2e_has_test_cases -v
```

### Run normal tests (E2E tests automatically skipped):
```bash
docker-compose exec backend pytest tests/
```

## File Naming Requirements

**Critical:** Files must be named exactly as shown:

### Statement file (choose one):
- `statement.pdf`
- `statement.csv`
- `statement.xlsx`

### Expected MT940:
- `expected.mt940`

### Generated MT940 (automatic):
- `generated.mt940` (created by test)

## Multiple Test Cases

You can create multiple test cases:

```
backend/tests/fixtures/e2e/
├── mbank_january_2024/
│   ├── statement.pdf
│   └── expected.mt940
├── mbank_february_2024/
│   ├── statement.pdf
│   └── expected.mt940
└── santander_q4_2023/
    ├── statement.csv
    └── expected.mt940
```

All tests run with a single command:
```bash
docker-compose exec backend pytest tests/test_e2e_bank_comparison.py --run-e2e -v
```

## Comparison Logic

The `MT940Comparator` class:

1. **Parses** both MT940 files using the `mt-940` library
2. **Extracts** transactions from each statement
3. **Compares**:
   - Transaction count
   - Each transaction's date
   - Each transaction's amount (with 1 cent tolerance)
   - Each transaction's description (warnings only)
4. **Reports** all differences in detail

## Troubleshooting

### "No test cases found"
- Verify directory: `backend/tests/fixtures/e2e/your_test_case/`
- Check file names: `statement.*` and `expected.mt940`
- Ensure files are not empty

### "Need --run-e2e option to run"
- This is intentional! Add `--run-e2e` flag
- Protects against accidental API credit usage

### Test fails with "Failed to parse MT940"
- Your `expected.mt940` might be invalid
- Test it manually:
  ```bash
  docker-compose exec backend python -c "
  import mt940
  with open('tests/fixtures/e2e/my_test/expected.mt940', 'r') as f:
      print(list(mt940.parse(f.read())))
  "
  ```

### Claude API errors
- Check `.env` has `ANTHROPIC_API_KEY`
- Verify you have API credits available

## Security Notes

⚠️ **Your test files contain real banking data:**
- Account numbers
- Transaction history
- Personal information

**Already protected:**
- All test fixtures are in `.gitignore`
- Files won't be committed accidentally
- Only README docs are tracked in git

**Best practices:**
- Delete test files after validation
- Use anonymized data for shared examples
- Never commit real financial data

## Documentation

Full documentation available in:
- `backend/tests/fixtures/e2e/README.md` - Comprehensive guide
- `backend/tests/fixtures/e2e/QUICKSTART.md` - Quick step-by-step guide
- `backend/tests/test_e2e_bank_comparison.py` - Inline docstrings

## Next Steps

1. **Add your test case:**
   ```bash
   mkdir -p backend/tests/fixtures/e2e/my_first_test
   cp your_statement.pdf backend/tests/fixtures/e2e/my_first_test/statement.pdf
   cp your_bank.mt940 backend/tests/fixtures/e2e/my_first_test/expected.mt940
   ```

2. **Run the test:**
   ```bash
   docker-compose exec backend pytest tests/test_e2e_bank_comparison.py --run-e2e -v
   ```

3. **Review results:**
   - Check console output for pass/fail
   - Review `generated.mt940` if needed
   - Compare with `expected.mt940` manually if desired

## Technical Details

**Test Class:** `TestEndToEndBankComparison`

**Key Methods:**
- `discover_test_cases()` - Auto-discovers test cases
- `MT940Comparator.compare_transactions()` - Compares MT940 files
- `test_pdf_to_mt940_matches_bank()` - Main test method

**Pytest Integration:**
- Custom `--run-e2e` command-line option
- Custom `@pytest.mark.e2e` marker
- Automatic test skipping without flag
- Parametrized tests for multiple cases

**Dependencies:**
- `mt940` library for parsing
- `ClaudeDocumentParser` for conversion
- `pytest` for test framework

## Support

For issues or questions:
1. Check `QUICKSTART.md` for common issues
2. Review `README.md` for detailed docs
3. Examine the test code for understanding
4. Open a GitHub issue if needed

---

**Ready to test!** Just add your PDF and MT940 files to the `e2e/` directory and run the test. 🚀
