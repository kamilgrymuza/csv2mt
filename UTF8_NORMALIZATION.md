# UTF-8 Normalization in MT940 Conversion

## Summary

All MT940 files generated by this application are now standardized to **UTF-8 encoding**, regardless of the input file's encoding.

## Changes Made

### 1. API Endpoints (âœ… Complete)

**File:** `backend/app/routers/conversion.py`

**Changes:**
- Both `/csv-to-mt940` and `/auto-convert` endpoints now explicitly encode MT940 output as UTF-8
- Added `Content-Type: text/plain; charset=utf-8` header to responses
- All downloaded MT940 files are UTF-8

**Code:**
```python
return Response(
    content=mt940_content.encode('utf-8'),
    media_type="application/octet-stream",
    headers={
        "Content-Disposition": f"attachment; filename={filename}",
        "Content-Type": "text/plain; charset=utf-8"
    }
)
```

### 2. CLI Tool (âœ… Complete)

**File:** `backend/convert_document.py`

**Changes:**
- CLI tool now explicitly saves MT940 files with UTF-8 encoding
- Shows "(UTF-8)" in success message

**Command:**
```bash
docker-compose exec backend python convert_document.py statement.pdf -o output.mt940
```

**Output:**
```
âœ“ MT940 file saved to: output.mt940 (UTF-8)
```

### 3. Claude Parser (âœ… Already UTF-8)

**File:** `backend/app/services/claude_parser.py`

**Status:** No changes needed
- Python strings are UTF-8 by default
- `convert_to_mt940()` method returns UTF-8 strings

### 4. E2E Tests (âœ… Complete)

**File:** `backend/tests/test_e2e_bank_comparison.py`

**Changes:**
- Automatically detects encoding of bank-provided MT940 files
- Converts expected MT940 to UTF-8 before comparison
- Saves UTF-8 version as `expected_utf8.mt940` for future use
- Both generated and expected MT940s are compared in UTF-8

**Test Output:**
```
ðŸ“„ Expected MT940 encoding: latin-1
   Converting from latin-1 to UTF-8 for comparison
   Saved UTF-8 version: expected_utf8.mt940
```

## File Encoding Flow

### Before (Mixed Encodings)
```
Bank Statement (Any encoding)
  â†“
Claude AI Parser
  â†“
MT940 String (Python default)
  â†“
Output File (Encoding unspecified - could vary)
```

### After (UTF-8 Normalization)
```
Bank Statement (Any encoding: Latin-1, UTF-8, CP1252, etc.)
  â†“
Claude AI Parser (reads with proper encoding detection)
  â†“
MT940 String (Python UTF-8)
  â†“
Output File (Explicitly UTF-8)
         â†“
    âœ… Always UTF-8
```

## Benefits

### 1. **Consistency**
- All generated MT940 files use the same encoding
- No surprises when sharing files between systems

### 2. **Universal Compatibility**
- UTF-8 is universally supported
- Works across all platforms (Windows, Mac, Linux)
- Compatible with modern banking systems

### 3. **Full Character Support**
- Supports all international characters (Polish: Ä…, Ä‡, Ä™, Å‚, Å„, Ã³, Å›, Åº, Å¼)
- Currency symbols (â‚¬, Â£, $, zÅ‚)
- Diacritics (Ã¤, Ã¶, Ã¼, Ã , Ã¨, Ã¬, Ã², Ã¹)
- No data loss from character conversion

### 4. **E2E Testing**
- Apples-to-apples comparison (UTF-8 vs UTF-8)
- No encoding mismatches in test results
- Saved UTF-8 versions for faster future comparisons

## Testing

### Test UTF-8 Output

**Check encoding of any MT940 file:**
```bash
docker-compose exec backend python detect_encoding.py <file.mt940>
```

**Example:**
```bash
docker-compose exec backend python detect_encoding.py tests/fixtures/e2e/ing_corporate/generated.mt940
```

**Expected output:**
```
âœ… Detected encoding: utf-8
   File size: 2118 characters
   MT940 markers found: :20:, :25:, :28C:, :60F:, :61:, :86:, :62F:
```

### Verify API Response

```bash
# Upload a file and save response
curl -X POST "http://localhost:8000/api/conversion/auto-convert" \
  -H "Authorization: Bearer $TOKEN" \
  -F "file=@statement.pdf" \
  -o output.mt940

# Check encoding
file -I output.mt940
# Should show: text/plain; charset=utf-8
```

### Run E2E Tests

```bash
docker-compose exec backend pytest tests/test_e2e_bank_comparison.py --run-e2e -v
```

**Expected behavior:**
1. Detects original encoding (e.g., `latin-1`)
2. Converts to UTF-8
3. Saves `expected_utf8.mt940`
4. Compares UTF-8 to UTF-8

## Files Created

### During E2E Tests

**Before first run:**
```
e2e/ing_corporate/
â”œâ”€â”€ statement.pdf          # Original bank statement
â””â”€â”€ expected.mt940         # Bank's MT940 (may be latin-1, cp1252, etc.)
```

**After first run:**
```
e2e/ing_corporate/
â”œâ”€â”€ statement.pdf          # Original bank statement
â”œâ”€â”€ expected.mt940         # Bank's MT940 (original encoding preserved)
â”œâ”€â”€ expected_utf8.mt940    # UTF-8 version (auto-generated)
â””â”€â”€ generated.mt940        # Claude AI generated (UTF-8)
```

## Backward Compatibility

### Reading Old MT940 Files

The system still **reads** MT940 files in any encoding:
- âœ… UTF-8
- âœ… Latin-1 (ISO-8859-1)
- âœ… Windows-1252
- âœ… ISO-8859-2
- âœ… UTF-8-SIG (with BOM)

### Writing New MT940 Files

The system **always writes** UTF-8:
- API endpoints â†’ UTF-8
- CLI tool â†’ UTF-8
- E2E tests â†’ UTF-8

## Migration Guide

### For Existing Integrations

**No action required!** The change is backward compatible:
- Old MT940 files can still be read
- New MT940 files are UTF-8
- All systems should handle UTF-8 properly

### Converting Existing Files

If you have old MT940 files in different encodings and want to convert them:

```bash
# Automatic conversion
docker-compose exec backend python -c "
from pathlib import Path

# Read with auto-detection
file = Path('old_file.mt940')
for encoding in ['utf-8', 'latin-1', 'cp1252', 'iso-8859-1']:
    try:
        content = file.read_text(encoding=encoding)
        # Write as UTF-8
        Path('new_file_utf8.mt940').write_text(content, encoding='utf-8')
        print(f'Converted from {encoding} to UTF-8')
        break
    except UnicodeDecodeError:
        continue
"
```

Or use the CLI:
```bash
# Read any encoding, output UTF-8
docker-compose exec backend python convert_document.py old_file.mt940 -o new_file_utf8.mt940
```

## Technical Details

### Python String Encoding

Python 3 strings are Unicode by default:
```python
# This is already Unicode (UTF-8 compatible)
mt940_content = ":20:STATEMENT\n:25:123456789\n"

# Explicitly encode to UTF-8 bytes when writing
with open('file.mt940', 'wb') as f:
    f.write(mt940_content.encode('utf-8'))

# Or use text mode (UTF-8 default)
with open('file.mt940', 'w', encoding='utf-8') as f:
    f.write(mt940_content)
```

### FastAPI Response Encoding

```python
# Bytes with explicit encoding
Response(
    content=text.encode('utf-8'),
    headers={"Content-Type": "text/plain; charset=utf-8"}
)
```

### E2E Test Encoding Detection

```python
# Try multiple encodings
for encoding in ['utf-8', 'latin-1', 'cp1252', 'iso-8859-1']:
    try:
        content = file.read_text(encoding=encoding)
        detected_encoding = encoding
        break
    except UnicodeDecodeError:
        continue
```

## References

- [UTF-8 Everywhere](http://utf8everywhere.org/)
- [Python Unicode HOWTO](https://docs.python.org/3/howto/unicode.html)
- [FastAPI Response](https://fastapi.tiangolo.com/advanced/custom-response/)
- [Character Encodings Guide](backend/ENCODING_GUIDE.md)

## FAQ

**Q: Will my old MT940 files still work?**
- A: Yes! The system reads any encoding, only writes UTF-8.

**Q: What if I need Latin-1 output?**
- A: UTF-8 is a superset of ASCII and can represent all Latin-1 characters. Your receiving system should handle UTF-8.

**Q: How do I verify a file is UTF-8?**
- A: Use `python detect_encoding.py <file>` or `file -I <file>`

**Q: Can I disable UTF-8 conversion?**
- A: No, UTF-8 is the standard for all output. It's universally compatible.

**Q: What about the SWIFT MT940 standard?**
- A: SWIFT defines character sets (ISO 9735 EDIFACT), not file encodings. UTF-8 is compliant and recommended.

## Status

âœ… **Complete** - All MT940 output is now UTF-8
âœ… **Tested** - E2E tests verify UTF-8 normalization
âœ… **Documented** - This guide covers all aspects
âœ… **Backward Compatible** - Reads any encoding, writes UTF-8

---

**Last Updated:** 2025-10-15
**Version:** 1.0
